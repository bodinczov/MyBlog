<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ru">
<head>
    <meta charset="UTF-8"/>
    <title>–°—Ç–∞—Ç—å–∏ (–≤—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω)</title>
    <style>
        body{margin:0;font-family:Segoe UI,Arial,sans-serif;background:#fff}
        header{background:#ff7700;color:#fff;padding:1rem;display:flex;justify-content:space-between}
        article{border-bottom:1px solid #eee;padding:1rem}
        button.like, .comment-toggle {
            background:none;
            border:none;
            color:#ff7700;
            cursor:pointer;
            font-size:1rem;
        }
        .liked {
            color:red;
            font-weight:bold;
        }
        textarea{width:100%;height:4rem;padding:.5rem;border:1px solid #ddd;border-radius:4px}
        .comment{margin:.5rem 0;padding:.5rem;border-left:3px solid #ff7700;background:#fff8f0;position:relative}
        .comment button {
            position:absolute;
            top:4px;
            right:4px;
            background:none;
            border:none;
            color:#888;
            cursor:pointer;
        }
        .comment button:hover {
            color:red;
        }
    </style>
    <script>
        async function loadComments(articleId) {
            const container = document.getElementById("comments-" + articleId);
            if (container.dataset.loaded === "true") {
                container.style.display = container.style.display === "none" ? "block" : "none";
                return;
            }

            const token = localStorage.getItem("token");
            const response = await fetch(`/articles/${articleId}/comments`, {
                headers: {
                    "Authorization": "Bearer " + token
                }
            });
            const comments = await response.json();

            container.innerHTML = comments.map((c, i) =>
            `<div class="comment" id="comment-${c.id}">
                <b>${c.author}</b> <small>${c.createdAt}</small>
                <div>${c.text}</div>
                ${c.canDelete ? `<button onclick="deleteComment(${c.id}, 'comment-${c.id}')">üóë</button>` : ""}
             </div>`
            ).join("");

            container.style.display = "block";
            container.dataset.loaded = "true";
        }

        async function toggleLike(articleId) {
            const token = localStorage.getItem("token");
            const response = await fetch(`/articles/${articleId}/like`, {
                method: "POST",
                headers: {
                    "Authorization": "Bearer " + token
                }
            });

            if (response.ok) {
                const data = await response.json();
                const likeBtn = document.getElementById("like-btn-" + articleId);
                const likeCount = document.getElementById("like-count-" + articleId);

                likeCount.innerText = "‚ù§ " + data.likesCount;
                if (data.liked) {
                    likeBtn.classList.add("liked");
                } else {
                    likeBtn.classList.remove("liked");
                }
            }
        }

        async function deleteComment(commentId, commentDivId) {
            const token = localStorage.getItem("token");

            const confirmed = confirm("–£–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?");
            if (!confirmed) return;

            const response = await fetch(`/comments/${commentId}`, {
                method: "DELETE",
                headers: {
                    "Authorization": "Bearer " + token
                }
            });

            if (response.ok) {
                const div = document.getElementById(commentDivId);
                div.remove();
            } else {
                alert("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è");
            }
        }
    </script>
</head>
<body>
<header>
    <h1>–°—Ç–∞—Ç—å–∏</h1>
    <form th:action="@{/logout}" method="post">
        <button style="background:#fff;color:#ff7700;border:none;padding:.5rem 1rem;border-radius:4px;cursor:pointer">
            –í—ã–π—Ç–∏
        </button>
    </form>
</header>

<section th:each="article : ${articles}">
    <article>
        <h2 th:text="${article.title}">–ó–∞–≥–æ–ª–æ–≤–æ–∫</h2>
        <p th:text="${article.body}">–¢–µ–∫—Å—Ç ...</p>

        <button type="button"
                th:id="'like-btn-' + ${article.id}"
                th:onclick="'toggleLike(' + ${article.id} + ')'"
                class="like">
            <span th:id="'like-count-' + ${article.id}">‚ù§ 0</span>
        </button>

        <button class="comment-toggle" th:onclick="'loadComments(' + ${article.id} + ')'">
            –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
        </button>

        <div th:attr="id=${'comments-' + article.id}" data-loaded="false" style="display:none;"></div>

        <form th:action="@{/articles/{id}/comments(id=${article.id})}" method="post" style="margin-top:.5rem">
            <textarea name="text" placeholder="–í–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." required></textarea>
            <button type="submit"
                    style="background:#ff7700;border:none;color:#fff;padding:.5rem 1rem;border-radius:4px;cursor:pointer">
                –û—Ç–ø—Ä–∞–≤–∏—Ç—å
            </button>
        </form>
    </article>
</section>
</body>
</html>
